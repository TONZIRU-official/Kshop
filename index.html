<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã‹ã‚Earthã®å•†å“æƒ…å ±ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã§ã™ã€‚é¯–æ°‘ã®å‡ºå“æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…¬é–‹ä¸­ã€‚ï¼ˆã“ã®ã‚µã‚¤ãƒˆã¯éå…¬å¼ã§ã™ã€‚ï¼‰">
    <title>ã‹ã‚Earthå•†å“ãƒãƒ¼ã‚¿ãƒ«</title>
    <style>
        :root {
            --mc-green: #3cfb00;
            --mc-aqua: #55ffff;
            --mc-gold: #ffaa00;
            --cyber-bg: #0d0d0d;
            --panel-bg: rgba(20, 20, 20, 0.9);
        }

        body {
            background-color: var(--cyber-bg);
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .03) 25%, rgba(255, 255, 255, .03) 26%, transparent 27%),
                linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .03) 25%, rgba(255, 255, 255, .03) 26%, transparent 27%);
            background-size: 40px 40px;
            color: #eee;
            font-family: 'Consolas', 'Courier New', monospace;
            margin: 0; padding: 20px;
        }

        .header { text-align: center; padding: 20px 0 40px; }
        .header h1 { color: var(--mc-aqua); font-size: 2.2rem; text-shadow: 0 0 15px var(--mc-aqua); margin: 0; letter-spacing: 4px; }

        .main-container { display: grid; grid-template-columns: 1fr 350px; gap: 25px; max-width: 1200px; margin: 0 auto; }

        section {
            background: var(--panel-bg); border: 1px solid #333; padding: 25px;
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 25px;
        }

        h2 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #888; font-size: 0.75rem; border-bottom: 2px solid #333; padding: 10px; }
        td { padding: 14px 10px; border-bottom: 1px solid #222; font-size: 0.9rem; }

        .coordinate { color: var(--mc-aqua); font-weight: bold; }
        .price { color: var(--mc-green); font-weight: bold; }
        .seller-tag { color: #777; font-size: 0.8rem; }

        .btn-order {
            background: transparent; border: 1px solid var(--mc-aqua); color: var(--mc-aqua);
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
        }
        .btn-order:hover { background: var(--mc-aqua); color: #000; }

        .auth-panel { border: 1px solid var(--mc-aqua); position: sticky; top: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        input, select { background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; font-family: inherit; }
        
        .btn-submit {
            background: var(--mc-aqua); color: #000; border: none; padding: 15px;
            font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        
        .order-item { background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--mc-aqua); font-size: 0.8rem; }
        .btn-logout { background: #444; color: #fff; border: none; padding: 8px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-top: 10px; }

        #login-form, #user-dashboard { display: none; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .auth-panel { position: static; } }
    </style>
</head>
<body>

<header class="header"><h1>ã‹ã‚Earthå•†å“ãƒãƒ¼ã‚¿ãƒ«</h1></header>

<div class="main-container">
    <main>
        <section>
            <h2 style="color: var(--mc-aqua);">ğŸ›’ å•†å“æ¤œç´¢</h2>
            <div class="controls">
                <input type="search" id="search-box" placeholder="å•†å“åã‚„å‡ºå“è€…ã§æ¤œç´¢..." oninput="renderTable()">
                <select id="sort-select" onchange="renderTable()">
                    <option value="newest">æ–°ç€é †</option>
                    <option value="price-asc">ä¾¡æ ¼ã®å®‰ã„é †</option>
                    <option value="price-desc">ä¾¡æ ¼ã®é«˜ã„é †</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr><th>å“ç›®</th><th>å˜ä¾¡</th><th>åº§æ¨™</th><th>çŠ¶æ³</th><th>å‡ºå“è€…</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody id="trade-tbody"></tbody>
            </table>
        </section>
    </main>

    <aside>
        <section class="auth-panel">
            <div id="login-form">
                <h2 style="color: var(--mc-aqua);">ğŸ‘¤ å‡ºå“è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="input-group">
                    <input type="text" id="auth-mcid" placeholder="ã‚ãªãŸã®MCIDã‚’å…¥åŠ›">
                    <button class="btn-submit" onclick="login()">ç®¡ç†ç”»é¢ã‚’é–‹ã</button>
                    <p style="font-size:0.7rem; color:#888;">â€»æ­£ç¢ºãªMCIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div id="user-dashboard">
                <h2 style="color: var(--mc-aqua);">âš’ï¸ å‡ºå“ç®¡ç†</h2>
                <p id="welcome-msg" style="font-size: 0.8rem; color: var(--mc-aqua); margin-bottom: 15px;"></p>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <input type="text" id="in-name" placeholder="å•†å“å">
                    <input type="text" id="in-price" placeholder="ä¾¡æ ¼">
                    <input type="text" id="in-coords" placeholder="åº§æ¨™(X / Z)">
                    <select id="in-stock">
                        <option value="åœ¨åº«ã‚ã‚Š">åœ¨åº«ã‚ã‚Š</option>
                        <option value="åœ¨åº«åƒ…å°‘">åœ¨åº«åƒ…å°‘</option>
                        <option value="å—æ³¨ç”Ÿç”£">å—æ³¨ç”Ÿç”£</option>
                    </select>
                    <input type="text" id="hp_field" style="display:none !important;" tabindex="-1">
                    <button class="btn-submit" id="submit-btn" onclick="submitTrade()">å‡ºå“ãƒ»æ›´æ–°ã™ã‚‹</button>
                </div>

                <div id="my-products-container" style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                    <h3 style="font-size:0.8rem;">ã‚ãªãŸã®å‡ºå“ä¸­ãƒªã‚¹ãƒˆ</h3>
                    <div id="my-prods-list"></div>
                </div>

                <div class="order-list" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
                    <h3 style="font-size: 0.9rem; color: var(--mc-gold);">ğŸ“© å±Šã„ãŸæ³¨æ–‡</h3>
                    <div id="received-orders"></div>
                </div>
                <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </section>
    </aside>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwgOZAdKPfNjI_kL6RUmrFaFN3KicqyWTpOiORipcLjREa8zNeyGQ2zT8K6Z1nKtEuK/exec";
    let currentData = { products: [], orders: [] }; 
    let currentUser = JSON.parse(localStorage.getItem('trade_user_new')) || null;
    function getBotCheck() {
        const n1 = Math.floor(Math.random() * 10) + 1;
        const n2 = Math.floor(Math.random() * 10) + 1;
        const ans = prompt(`${n1} + ${n2} ã¯ï¼Ÿ `);
        return { user_ans: ans, captcha_ans: n1 + n2 };
    }

    async function loadTradeData() {
        try {
            const res = await fetch(GAS_URL + "?t=" + Date.now());
            const data = await res.json();
            currentData.products = data.products || [];
            currentData.orders = data.orders || [];
            renderTable();
            renderOrders();
            renderMyProducts();
        } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—"); }
    }

    function renderTable() {
        const tbody = document.getElementById('trade-tbody');
        const search = document.getElementById('search-box').value.toLowerCase();
        const filtered = currentData.products.filter(d => 
            d.name.toLowerCase().includes(search) || d.seller.toLowerCase().includes(search)
        );
        tbody.innerHTML = filtered.map(item => `
            <tr>
                <td><strong>${item.name}</strong></td>
                <td class="price">${item.price}</td>
                <td class="coordinate">${item.coords}</td>
                <td style="font-size:0.8rem;">${item.stock}</td>
                <td class="seller-tag">${item.seller}</td>
                <td><button class="btn-order" onclick="placeOrder('${item.seller}', '${item.name}')">æ³¨æ–‡</button></td>
            </tr>
        `).join('');
    }

    async function submitTrade() {
        if (!currentUser) return;
        const bot = getBotCheck();
        if (!bot.user_ans) return;

        const payload = {
            action: "updateProduct",
            seller: currentUser.mcid,
            name: document.getElementById('in-name').value,
            price: document.getElementById('in-price').value,
            coords: document.getElementById('in-coords').value,
            stock: document.getElementById('in-stock').value,
            hp_field: document.getElementById('hp_field').value,
            user_ans: bot.user_ans,
            captcha_ans: bot.captcha_ans
        };

        if (!payload.name) return alert("å•†å“åã¯å¿…é ˆã§ã™");
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;

        try {
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.status === "success") {
                alert("æ›´æ–°å®Œäº†ï¼");
                loadTradeData();
            } else { alert(result.message); }
        } catch (e) { alert("é€ä¿¡å¤±æ•—"); }
        btn.disabled = false;
    }

    async function placeOrder(seller, productName) {
        const buyer = prompt("æ³¨æ–‡è€…(ã‚ãªãŸã®MCID)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!buyer) return;
        const bot = getBotCheck();
        if (!bot.user_ans) return;

        try {
            const res = await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "placeOrder", buyer, seller, productName,
                    user_ans: bot.user_ans, captcha_ans: bot.captcha_ans
                }) 
            });
            const result = await res.json();
            if (result.status === "success") {
                alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
                loadTradeData();
            } else { alert(result.message); }
        } catch (e) { alert("æ³¨æ–‡å¤±æ•—"); }
    }

    function renderMyProducts() {
        const list = document.getElementById('my-prods-list');
        if (!currentUser || !list) return;
        const myProds = currentData.products.filter(p => p.seller === currentUser.mcid);
        list.innerHTML = myProds.map(p => `
            <div style="font-size:0.75rem; border-bottom:1px solid #222; padding:5px; display:flex; justify-content:space-between;">
                <span>${p.name}</span>
                <button onclick="deleteProduct('${p.name}')" style="color:#ff4444; background:none; border:none; cursor:pointer;">[å‰Šé™¤]</button>
            </div>
        `).join('');
    }

    async function deleteProduct(name) {
        if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const bot = getBotCheck();
        await fetch(GAS_URL, { method:"POST", body:JSON.stringify({
            action:"deleteProduct", name, seller:currentUser.mcid,
            user_ans: bot.user_ans, captcha_ans: bot.captcha_ans
        })});
        loadTradeData();
    }

    function renderOrders() {
        const container = document.getElementById('received-orders');
        if (!currentUser || !container) return;
        const myOrders = currentData.orders.filter(o => o.seller === currentUser.mcid);
        container.innerHTML = myOrders.map(o => `
            <div class="order-item">
                <b>${o.buyer}</b> â†’ ${o.productName}
                <button onclick="deleteOrder('${o.id}')" style="color:#ff4444; background:none; border:none; cursor:pointer; float:right;">[å®Œäº†]</button>
            </div>
        `).join('');
    }

    async function deleteOrder(orderId) {
        const bot = getBotCheck();
        await fetch(GAS_URL, { method:"POST", body:JSON.stringify({
            action:"deleteOrder", orderId,
            user_ans: bot.user_ans, captcha_ans: bot.captcha_ans
        })});
        loadTradeData();
    }

    function checkAuth() {
        const loginForm = document.getElementById('login-form');
        const dashboard = document.getElementById('user-dashboard');
        if (currentUser) {
            loginForm.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('welcome-msg').innerText = `MCID: ${currentUser.mcid}`;
            renderMyProducts();
            renderOrders();
        } else {
            loginForm.style.display = 'block';
            dashboard.style.display = 'none';
        }
    }

    function login() {
        const mcid = document.getElementById('auth-mcid').value;
        if (!mcid) return alert("MCIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        currentUser = { mcid };
        localStorage.setItem('trade_user_new', JSON.stringify(currentUser));
        checkAuth();
    }

    function logout() {
        localStorage.removeItem('trade_user_new');
        currentUser = null;
        checkAuth();
    }

    window.onload = () => {
        checkAuth();
        loadTradeData();
        setInterval(loadTradeData, 60000);
    };
</script>
</body>
</html>

